<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Tests de couverture - FixBox & MaxBox</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

  <style>
    html, body {
      margin: 0;
      height: 100%;
      font-family: sans-serif;
      background: #121212;
      color: white;
      display: flex;
      flex-direction: row;
    }

    /* Division verticale en deux moitiés */
    .map-container {
      position: relative;
      width: 50%;
      height: 100%;
    }

    #mapFix, #mapMax {
      width: 100%;
      height: 100%;
    }

    /* Titres */
    .map-title {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1001;
      font-size: 24px;
      font-weight: bold;
      color: #ffc107;
      background: rgba(0, 0, 0, 0.6);
      padding: 8px 16px;
      border-radius: 10px;
      text-align: center;
    }

    /* Légende commune */
    .legend {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.6);
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 13px;
      z-index: 1000;
    }

    .gradient-bar {
      height: 10px;
      width: 120px;
      background: linear-gradient(to right, yellow, orange, red);
      border-radius: 5px;
      margin-top: 6px;
    }

    /* Fond bleu pour la carte MaxBox */
    #mapMax {
      background-color: #001e5f;
    }

    @media (max-width: 900px) {
      body {
        flex-direction: column;
      }
      .map-container {
        width: 100%;
        height: 50%;
      }
    }
  </style>
</head>
<body>

  <div class="map-container">
    <div id="mapFix"></div>
    <div class="map-title">FixBox</div>
  </div>

  <div class="map-container">
    <div id="mapMax"></div>
    <div class="map-title">MaxBox</div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

  <script>
    // Fonction utilitaire : création d'une carte Leaflet
    function createMap(containerId, csvFile, colorMode) {
      const map = L.map(containerId).setView([33.9, 9.5], 7);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OSM, © CARTO'
      }).addTo(map);

      fetch("tunisia_gouvernorats.json")
        .then(res => res.json())
        .then(geojsonData => {
          L.geoJSON(geojsonData, {
            style: { color: '#444', weight: 1, fill: false }
          }).addTo(map);

          Papa.parse(csvFile, {
            download: true,
            header: true,
            delimiter: ",",
            dynamicTyping: true,
            complete: function(results) {
              const data = results.data.filter(r => r.latitude && r.longitude && r.tests);
              if (!data.length) return;

              const values = data.map(r => r.tests);
              const min = Math.min(...values);
              const max = Math.max(...values);

              const markers = L.markerClusterGroup();

              data.forEach(r => {
                let gov = "Inconnu";
                for (const f of geojsonData.features) {
                  if (turf.booleanPointInPolygon(turf.point([r.longitude, r.latitude]), f.geometry)) {
                    gov = f.properties.gov_name_f;
                    break;
                  }
                }

                // couleur selon mode
                let color;
                if (colorMode === "fix") {
                  const ratio = (r.tests - min) / (max - min);
                  const g = Math.round(255 - 200 * ratio);
                  color = `rgb(255,${g},0)`; // tons orange/rouge
                } else {
                  const ratio = (r.tests - min) / (max - min);
                  const b = 255;
                  const g = Math.round(200 - 150 * ratio);
                  color = `rgb(0,${g},${b})`; // tons bleu clair → bleu foncé
                }

                const marker = L.circleMarker([r.latitude, r.longitude], {
                  radius: 6,
                  color: color,
                  fillColor: color,
                  fillOpacity: 0.8,
                  weight: 1
                }).bindPopup(`<b>Gouvernorat:</b> ${gov}<br><b>Tests:</b> ${r.tests}`);
                markers.addLayer(marker);
              });

              map.addLayer(markers);
            }
          });
        });
    }

    // Créer les deux cartes
    createMap("mapFix", "data.csv", "fix");
    createMap("mapMax", "dataMX.csv", "max");
  </script>

</body>
</html>
